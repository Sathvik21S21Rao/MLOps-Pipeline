---
- name: Ensure k8s namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ k8s_namespace }}"
    state: present

- name: Ensure model-output-pvc exists (created by trainer)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ pvc_name | default('model-output-pvc') }}"
        namespace: "{{ k8s_namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "5Gi"

- name: Delete previous inference service (if exists)
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: "inference-service-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
    state: absent
  ignore_errors: true

- name: Delete previous inference deployment (if exists)
  kubernetes.core.k8s:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
    state: absent
  ignore_errors: true

- name: Wait for previous deployment to terminate (optional)
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
  register: prev_deploy_info
  retries: 6
  delay: 2
  until: prev_deploy_info.resources | length == 0
  # if deployment didn't exist, this will pass quickly

- name: Apply model inference deployment
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'model-inference-deployment.yaml.j2') }}"
  register: deployment_apply

- name: Apply model inference service
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'model-inference-service.yaml.j2') }}"
  register: service_apply

- name: Wait for deployment to report ready replicas
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
  register: deploy_info
  until: >
    deploy_info.resources
    and deploy_info.resources[0].status is defined
    and (deploy_info.resources[0].status.readyReplicas | default(0)) | int >= (lookup('vars', 'deployment_min_replicas') | default(1) | int)
  retries: 30
  delay: 5

- name: Show deployment status
  debug:
    msg:
      - "Deployment applied: {{ deployment_apply | default({}) | json }} "
      - "Service applied: {{ service_apply | default({}) | json }} "
      - "Deployment readyReplicas: {{ deploy_info.resources[0].status.readyReplicas | default(0) }}"

# Optional: gather pods and print logs (helpful for debugging first deploy)
- name: Gather pods for the inference deployment (for logs) - optional
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ k8s_namespace }}"
    label_selectors:
      - "app=inference"
      - "model={{ model_name }}"
  register: inference_pods
  when: debug | default(false)

- name: Print inference pod names (optional)
  debug:
    msg: "Inference pods: {{ inference_pods.resources | map(attribute='metadata.name') | list }}"
  when: debug | default(false)

- name: Fetch logs from inference pods (optional)
  when: (debug | default(false)) and inference_pods.resources | length > 0
  block:
    - name: Get logs for each inference pod
      kubernetes.core.k8s_log:
        namespace: "{{ k8s_namespace }}"
        name: "{{ item.metadata.name }}"
      loop: "{{ inference_pods.resources }}"
      register: pod_logs

    - name: Show last logs (optional)
      debug:
        msg: "{{ item.stdout | default(item) }}"
      loop: "{{ pod_logs.results }}"
