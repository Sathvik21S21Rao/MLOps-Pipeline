---
- name: Ensure k8s namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ k8s_namespace }}"
    state: present

- name: Ensure model-output-pvc exists (created by trainer)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ pvc_name | default('model-output-pvc') }}"
        namespace: "{{ k8s_namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "5Gi"

- name: Delete previous inference service (if exists)
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: "inference-service-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
    state: absent
  ignore_errors: true

- name: Delete previous inference deployment (if exists)
  kubernetes.core.k8s:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
    state: absent
  ignore_errors: true

- name: Wait for previous deployment to terminate
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
  register: prev_deploy_info
  until: (prev_deploy_info.resources | length) == 0
  retries: 6
  delay: 2

- name: Apply model inference deployment
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'model-inference-deployment.yaml.j2') }}"
  register: deployment_apply

- name: Apply model inference service
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'model-inference-service.yaml.j2') }}"
  register: service_apply

##############################################################
#                      IMPORTANT: FIXED
##############################################################
# the following checks if enough deployment pods exist. fails after 30*5 seconds

- name: Wait for deployment to report ready replicas
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "inference-deployment-{{ model_name }}"
    namespace: "{{ k8s_namespace }}"
  register: deploy_info
  until: >
    (deploy_info.resources | length) > 0
    and (deploy_info.resources[0].status is defined)
    and ((deploy_info.resources[0].status.readyReplicas | default(0) | int) >=
         (deployment_min_replicas | default(1) | int))
  retries: 30
  delay: 5

##############################################################

- name: Show deployment status
  debug:
    msg:
      - "Deployment applied: {{ deployment_apply | to_nice_json }}"
      - "Service applied: {{ service_apply | to_nice_json }}"
      - "Deployment readyReplicas: {{ deploy_info.resources[0].status.readyReplicas | default(0) }}"

# Optional debugging
- name: Gather inference pods
  when: debug | default(false)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ k8s_namespace }}"
    label_selectors:
      - "app=modelinference"
      - "model={{ model_name }}"
  register: inference_pods

- name: Show pod names
  when: debug | default(false)
  debug:
    msg: "Inference pods: {{ inference_pods.resources | map(attribute='metadata.name') | list }}"

- name: Fetch logs from inference pods
  when: debug | default(false) and (inference_pods.resources | length) > 0
  block:
    - name: Get logs
      kubernetes.core.k8s_log:
        namespace: "{{ k8s_namespace }}"
        name: "{{ item.metadata.name }}"
      loop: "{{ inference_pods.resources }}"
      register: pod_logs

    - name: Show logs
      debug:
        msg: "{{ item.stdout | default(item) }}"
      loop: "{{ pod_logs.results }}"
